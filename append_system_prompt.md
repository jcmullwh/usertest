# Ticket context
- fingerprint: 6adffdc71940f9be
- ticket_id: BLG-007
- title: Make `pdm` non-fragile in verification/setup (preflight + fallback or ensure installed)
- export_kind: implementation
- owner_repo_root: I:\code\usertest
- idea_path: .agents\plans\1 - ideas\20260224_BLG-007_6adffdc71940f9be_setup-preflight-fallback-or-ensure-installed.md

# Ticket markdown
# Make `pdm` non-fragile in verification/setup (preflight + fallback or ensure installed)

Generated by `python -m usertest_backlog.cli reports export-tickets` on 2026-02-24T14:18:52Z.
- Fingerprint: `6adffdc71940f9be`
- Source ticket: `BLG-007`

- Source ticket: `BLG-007`
- Fingerprint: `6adffdc71940f9be`
- Export kind: `implementation`
- Stage: `ready_for_ticket`
- Severity: `high`
- Change surface kinds: `behavior_change`
- User-visible: `true` (high-surface gated: `false`)

## Title

Make `pdm` non-fragile in verification/setup (preflight + fallback or ensure installed)

## Problem

Verification/setup paths invoke `pdm` in environments where it is missing or non-functional, causing early exit_code=1 failures with unclear remediation and no supported fallback.

## User impact

Common setup/smoke/verification workflows fail immediately in some environments, blocking progress and creating confusing/unactionable failures.

## Proposed fix

Add a single preflight that checks `pdm` (and other required tools) and either (a) provides an explicit pip/venv fallback path, or (b) fails fast with clear install/remediation steps; alternatively, install `pdm` in the runner/sandbox images wherever workflows require it and report versions deterministically.

## Investigation steps

- Trace exactly which scripts/tests/runner steps invoke `pdm` and whether it is required vs optional.
- Reproduce in a clean environment without `pdm` and capture stdout/stderr for actionable messaging (missing binary vs runtime dependency issue).
- Decide on a single supported dependency-management path for verification per environment (pdm vs pip/venv) and align automation/docs.
- Implement a deterministic preflight that reports tool availability/versions and gates only when tools are truly required.
- If `pdm` is required, bake it into the runner/sandbox images and verify PATH/tooling across platforms.

## Success criteria

- `pdm --version` succeeds in environments where workflows invoke `pdm` (or those workflows no longer invoke `pdm`).
- In environments without `pdm`, workflows either proceed via a supported fallback or fail with a single clear preflight error and install instructions.
- Verification/setup no longer fails mid-flow solely due to missing `pdm` (unless explicitly required and preflight-gated).
- Run artifacts/logs include deterministic tool version reporting (or explicit missing-tool reporting).

## Evidence breadth (counts)

- missions: 1
- targets: 1
- repo_inputs: 1
- agents: 1
- personas: 1
- runs: 4

## Evidence atom ids

- `usertest/20260220T194226Z/codex/0:command_failure:1`
- `usertest/20260220T194226Z/codex/0:command_failure:2`
- `usertest/20260220T194226Z/codex/0:command_failure:3`
- `usertest/20260221T234742Z/codex/0:command_failure:2`
- `usertest/20260221T234742Z/codex/0:command_failure:3`
- `usertest/20260221T234742Z/codex/0:command_failure:4`
- `usertest/20260221T234742Z/codex/0:command_failure:5`
- `usertest/20260221T234742Z/codex/0:command_failure:6`
- `usertest/20260221T234742Z/codex/0:command_failure:9`
- `usertest/20260224T033438Z/codex/0:command_failure:5`
- `usertest/20260224T122753Z/codex/0:command_failure:7`

<!-- usertest:ux_review:start -->
## UX review

- ux_review.json: `I:\code\usertest\runs\usertest_implement\usertest\_compiled\usertest.ux_review.json`
- ux_review.md: `I:\code\usertest\runs\usertest_implement\usertest\_compiled\usertest.ux_review.md`
- reviewer_status: `ok`
- reviewer_generated_at: `2026-02-24T14:15:41Z`
- reviewer_prompt_hash: `c4db8de7bf048e40`
- reviewer_confidence: `0.64`

### UX-001: parameterize_existing (BLG-007)

The intent snapshot already documents a first-run readiness check (`python tools/scaffold/scaffold.py doctor`), OS-specific one-command smoke scripts, and an explicit philosophy of minimizing command surface. BLG-009’s proposed new command duplicates an existing documented entrypoint and would add high-surface area without breadth across missions/targets. The other tickets in this cluster describe failures that are best solved by making current flows more capability-aware and self-diagnosing (pdm missing, import shadowing, and making the one-command path the default), which aligns with the repo’s “loud failures” and reproducibility constraints.

Next steps:
- Treat `python tools/scaffold/scaffold.py doctor` as the canonical prerequisite surface; update README/docs and any CLI remediation strings to point to it plus the OS-specific one-command scripts.
- Add a single, deterministic tool preflight result record that smoke/verification paths can consume (e.g., pdm present/absent; chosen fallback).
- Ensure any verification/setup path that currently invokes `pdm` either (a) checks first and falls back to pip/venv, or (b) fails fast with one-screen remediation.
- Implement a consistent import-origin guard in existing smoke entrypoints (scripts and smoke shortcut) that prints the resolved module path and fails with clear guidance when it’s outside the workspace.

Evidence breadth: `missions=1, targets=1, repo_inputs=2, agents=2, runs=4`

Raw recommendation JSON:

```json
{
  "recommendation_id": "UX-001",
  "ticket_ids": [
    "BLG-007",
    "BLG-009",
    "BLG-021",
    "BLG-023"
  ],
  "recommended_approach": "parameterize_existing",
  "proposed_change_surface": {
    "user_visible": true,
    "kinds": [
      "behavior_change",
      "docs_change"
    ],
    "notes": "Consolidate onboarding/verification into the already-documented surfaces: keep `python tools/scaffold/scaffold.py doctor` as the single prerequisite check, make the one-command scripts the primary discovery path, make `pdm` optional via deterministic preflight+fallback, and add an import-shadowing guard to existing smoke entrypoints (scripts and any existing smoke shortcut). Avoid adding `usertest doctor` as a new top-level command."
  },
  "rationale": "The intent snapshot already documents a first-run readiness check (`python tools/scaffold/scaffold.py doctor`), OS-specific one-command smoke scripts, and an explicit philosophy of minimizing command surface. BLG-009’s proposed new command duplicates an existing documented entrypoint and would add high-surface area without breadth across missions/targets. The other tickets in this cluster describe failures that are best solved by making current flows more capability-aware and self-diagnosing (pdm missing, import shadowing, and making the one-command path the default), which aligns with the repo’s “loud failures” and reproducibility constraints.",
  "next_steps": [
    "Treat `python tools/scaffold/scaffold.py doctor` as the canonical prerequisite surface; update README/docs and any CLI remediation strings to point to it plus the OS-specific one-command scripts.",
    "Add a single, deterministic tool preflight result record that smoke/verification paths can consume (e.g., pdm present/absent; chosen fallback).",
    "Ensure any verification/setup path that currently invokes `pdm` either (a) checks first and falls back to pip/venv, or (b) fails fast with one-screen remediation.",
    "Implement a consistent import-origin guard in existing smoke entrypoints (scripts and smoke shortcut) that prints the resolved module path and fails with clear guidance when it’s outside the workspace."
  ],
  "evidence_breadth_summary": {
    "missions": 1,
    "targets": 1,
    "repo_inputs": 2,
    "agents": 2,
    "runs": 4
  }
}
```

<!-- usertest:ux_review:end -->
